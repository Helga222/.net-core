<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Список книг</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <h2>Список книг</h2>

    <!--------------Authorization--------------------->
    <form name="authorizationForm">
        <div id="userInfo" style="display:none;">
            <p>Вы вошли как: <span id="userName"></span></p>
            <input type="button" value="Выйти" id="logOut" />
        </div>
        <div id="loginForm">
            <h3>Вход на сайт</h3>
            <label>Введите email</label><br />
            <input type="email" id="emailLogin" /> <br /><br />
            <label>Введите пароль</label><br />
            <input type="password" id="passwordLogin" /><br /><br />
            <input type="submit" id="submitLogin" value="Логин" />
        </div>
        <div>
            <input type="submit" id="getDataByLogin" value="Данные по логину" />
        </div>
        <div>
            <input type="submit" id="getDataByRole" value="Данные по роли" />
        </div>
    </form>


    <!--//--------------------------------->
    <form name="bookForm" id="bookForm" style="display:none;">
        <input type="hidden" name="id" value="0" />
        <div class="form-group col-md-5">
            <label for="name">Название:</label>
            <input class="form-control" name="name" />
        </div>
        <div class="form-group col-md-5">
            <label for="author">Автор:</label>
            <input class="form-control" name="author" />
        </div>
        <div class="form-group col-md-5">
            <label for="pages">Количество страниц:</label>
            <input class="form-control" name="pages" type="number" />
        </div>
        <div class="form-group col-md-5">
            <label for="cover">Тип обложки:</label>
            <input class="form-control" name="cover" type="number" />
        </div>
        <div class="form-group col-md-5">
            <label for="description">Описание</label>
            <input class="form-control" name="description" />
        </div>
        <div class="form-group col-md-5">
            <label for="category">Категории:</label>
            <select name="category" class="form-control">
            </select>
            <input type="text" name="categoryInput" value="" placeholder="Введите название категории">
            <button type="button" onclick="addCategoryOnClickHandler()">Add New Category</button>
        </div>
        <div class="panel-body">
            <button type="submit" id="submit" class="btn btn-primary">Сохранить</button>
            <a id="reset" class="btn btn-primary">Сбросить</a>
        </div>

    </form>
    <table class="table table-condensed table-striped  col-md-6">
        <thead>
            <tr>
                <th>Id</th>
                <th>Название</th>
                <th>Автор</th>
                <th>Количество страниц</th>
                <th>Тип обложки</th>
                <th>Описание</th>
                <th>Категория</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script>

       /* -----------------Authorization------------------------*/
        var tokenKey = "accessToken";

        // отпавка запроса к контроллеру AccountController для получения токена
        async function getTokenAsync() {

            // получаем данные формы и фомируем объект для отправки
            const formData = new FormData();
            formData.append("grant_type", "password");
            formData.append("username", document.getElementById("emailLogin").value);
            formData.append("password", document.getElementById("passwordLogin").value);

            // отправляет запрос и получаем ответ
            const response = await fetch("/token", {
                method: "POST",
                headers: { "Accept": "application/json" },
                body: formData
            });
            // получаем данные
            const data = await response.json();

            // если запрос прошел нормально
            if (response.ok === true) {

                // изменяем содержимое и видимость блоков на странице
                document.getElementById("userName").innerText = data.username;
                document.getElementById("userInfo").style.display = "block";
                document.getElementById("bookForm").style.display = "";
                document.getElementById("loginForm").style.display = "none";
                // сохраняем в хранилище sessionStorage токен доступа
                sessionStorage.setItem(tokenKey, data.access_token);
                console.log(data.access_token);
            }
            else {
                // если произошла ошибка, из errorText получаем текст ошибки
                console.log("Error: ", response.status, data.errorText);
            }
        };
        // отправка запроса к контроллеру ValuesController
        async function getData(url) {
            const token = sessionStorage.getItem(tokenKey);

            const response = await fetch(url, {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + token  // передача токена в заголовке
                }
            });
            if (response.ok === true) {

                const data = await response.json();
                alert(data)
            }
            else
                console.log("Status: ", response.status);
        };

        // получаем токен
        document.getElementById("submitLogin").addEventListener("click", e => {

            e.preventDefault();
            getTokenAsync();
        });

        // условный выход - просто удаляем токен и меняем видимость блоков
        document.getElementById("logOut").addEventListener("click", e => {

            e.preventDefault();
            document.getElementById("userName").innerText = "";
            document.getElementById("userInfo").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
            sessionStorage.removeItem(tokenKey);
        });


        // кнопка получения имя пользователя  - /api/values/getlogin
        document.getElementById("getDataByLogin").addEventListener("click", e => {

            e.preventDefault();
            getData("/api/values/getlogin");
        });

        // кнопка получения роли  - /api/values/getrole
        document.getElementById("getDataByRole").addEventListener("click", e => {

            e.preventDefault();
            getData("/api/values/getrole");
        });

        /* -----------------BookShop------------------------*/
            async function GetCategories() {
                // отправляет запрос и получаем ответ
                const response = await fetch("/api/category", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                // если запрос прошел нормально
                if (response.ok === true) {
                    // получаем данные
                    const categories = await response.json();
                    let selectElement = document.getElementsByName("category")[0];
                    selectElement.innerHTML = ""
                    categories.forEach(category => {
                        AddCategoryToSelect(category.categoryType)
                    });
                }
            }

            async function AddCategoryToSelect(categoryType) {
                let selectElement = document.getElementsByName("category")[0];
                var option = new Option(categoryType, categoryType);
                selectElement.appendChild(option);
            }

            async function addCategoryOnClickHandler() {
                let inputElement = document.getElementsByName("categoryInput")[0];
                AddCategoryToSelect(inputElement.value);

                const response = await fetch("api/category", {
                    method: "POST",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        categoryType: inputElement.value,
                    })
                });

                inputElement.value = ""
            }

            // Получение всех пользователей
            async function GetBooks() {
                // отправляет запрос и получаем ответ
                const response = await fetch("/api/book", {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                // если запрос прошел нормально
                if (response.ok === true) {
                    // получаем данные
                    const books = await response.json();
                    let rows = document.querySelector("tbody");
                    books.forEach(book => {
                        // добавляем полученные элементы в таблицу
                        rows.append(row(book));
                    });
                }
            }
            // Получение одного пользователя
            async function GetBook(id) {
                const response = await fetch("/api/book/" + id, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const book = await response.json();
                    const form = document.forms["bookForm"];
                    form.elements["id"].value = book.id;
                    form.elements["name"].value = book.name;
                    form.elements["pages"].value = book.pages;
                    form.elements["author"].value = book.author;
                    form.elements["category"].value = book.category.categoryType;
                    form.elements["description"].value = book.description;
                    form.elements["cover"].value = book.cover;
                }
            }
            // Добавление пользователя
            async function CreateBook(name, author, pages, cover, description, category) {

                const response = await fetch("api/book", {
                    method: "POST",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: name,
                        author: author,
                        pages: parseInt(pages, 10),
                        cover: parseInt(cover, 10),
                        description: description,
                        category: category
                    })
                });
                if (response.ok === true) {
                    const book = await response.json();
                    reset();
                    document.querySelector("tbody").append(row(book));
                }
            }
            // Изменение пользователя
            async function EditBook(id, name, author, pages, cover, description, category) {
                const response = await fetch("api/book", {
                    method: "PUT",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: parseInt(id, 10),
                        name: name,
                        author: author,
                        pages: parseInt(pages, 10),
                        cover: parseInt(cover, 10),
                        description: description,
                        category: category
                    })
                });
                if (response.ok === true) {
                    const book = await response.json();
                    reset();
                    document.querySelector("tr[data-rowid='" + book.id + "']").replaceWith(row(book));
                }
            }
            // Удаление пользователя
            async function DeleteBook(id) {
                const response = await fetch("/api/book/" + id, {
                    method: "DELETE",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const book = await response.json();
                    document.querySelector("tr[data-rowid='" + book.id + "']").remove();
                }
            }

            // сброс формы
            function reset() {
                const form = document.forms["bookForm"];
                form.reset();
                form.elements["id"].value = 0;
            }
            // создание строки для таблицы
            function row(book) {

                const tr = document.createElement("tr");
                tr.setAttribute("data-rowid", book.id);

                const idTd = document.createElement("td");
                idTd.append(book.id);
                tr.append(idTd);

                const nameTd = document.createElement("td");
                nameTd.append(book.name);
                tr.append(nameTd);

                const authorTd = document.createElement("td");
                authorTd.append(book.author);
                tr.append(authorTd);

                const pagesTd = document.createElement("td");
                pagesTd.append(book.pages);
                tr.append(pagesTd);

                const coverTd = document.createElement("td");
                coverTd.append(book.cover);
                tr.append(coverTd);

                const descriptionTd = document.createElement("td");
                descriptionTd.append(book.description);
                tr.append(descriptionTd);

                const categoryTd = document.createElement("td");
                categoryTd.append(book.category.categoryType);
                tr.append(categoryTd);

                const linksTd = document.createElement("td");

                const editLink = document.createElement("a");
                editLink.setAttribute("data-id", book.id);
                editLink.setAttribute("style", "cursor:pointer;padding:15px;");
                editLink.append("Изменить");
                editLink.addEventListener("click", e => {

                    e.preventDefault();
                    GetBook(book.id);
                });
                linksTd.append(editLink);

                const removeLink = document.createElement("a");
                removeLink.setAttribute("data-id", book.id);
                removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
                removeLink.append("Удалить");
                removeLink.addEventListener("click", e => {

                    e.preventDefault();
                    DeleteBook(book.id);
                });

                linksTd.append(removeLink);
                tr.appendChild(linksTd);

                return tr;
            }
            // сброс значений формы
            document.getElementById("reset").click(function (e) {

                e.preventDefault();
                reset();
            })

            // отправка формы
            document.forms["bookForm"].addEventListener("submit", e => {
                e.preventDefault();
                const form = document.forms["bookForm"];
                const id = form.elements["id"].value;
                const name = form.elements["name"].value;
                const author = form.elements["author"].value;
                const description = form.elements["description"].value;
                const pages = form.elements["pages"].value;
                const cover = form.elements["cover"].value;
                const category = form.elements["category"].value;
                if (id == 0)
                    CreateBook(name, author, description, pages, cover, category);
                else
                    EditBook(id, name, author, description, pages, cover, category);
            });

            // загрузка пользователей
            GetBooks();
            GetCategories();

    </script>
</body>
</html>